<!doctype html>
<html lang="zh-cn">
	<head>
		<meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui" charset="UTF-8">
		<title>志愿快讯</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
				-webkit-text-size-adjust: none;
			}
			
			html {
				font-size: 10px;
			}
			
			body {
				background-color: #f5f5f5;
				font-size: 1.2em;
			}
			
			.outer {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
				-ms-flex-direction: column;
				-webkit-box-orient: vertical;
				box-orient: vertical;
				-webkit-flex-direction: column;
				flex-direction: column;
			}
			
			.inner {
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				-ms-flex: 1;
				flex: 1;
				background-color: #fff;
				overflow-y: scroll;
				-webkit-overflow-scrolling: touch;
			}
			
			.inner .item {
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
				-ms-flex-align: center;
				-webkit-box-align: center;
				box-align: center;
				-webkit-align-items: center;
				align-items: center;
				padding: 3.125%;
				border-bottom: 1px solid #ddd;
				color: #333;
				text-decoration: none;
			}
			
			.inner .item h3 {
				display: block;
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				-ms-flex: 1;
				flex: 1;
				width: 100%;
				max-height: 40px;
				overflow: hidden;
				line-height: 20px;
				margin: 0 10px;
				font-size: 1.2rem;
			}
			
			.inner .item .date {
				display: block;
				height: 20px;
				line-height: 20px;
				color: #999;
			}
			
			.opacity {
				-webkit-animation: opacity 0.3s linear;
				animation: opacity 0.3s linear;
			}
			
			@-webkit-keyframes opacity {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			
			@keyframes opacity {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
		</style>
		<link rel="stylesheet" href="../../dist/dropload.css">
	</head>

	<body>
		<div class="outer">
			<div class="inner">
				<div class="lists">
				</div>
			</div>
		</div>
		
	    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.2&key=35f9f2153f606c298de1f4f065deb49a"></script>
		<!-- jQuery1.7以上 或者 Zepto 二选一，不要同时都引用 -->
		<script src="../../js/zepto.min.js"></script>
		<script src="../../dist/dropload.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/comm.js"></script>
		<script>
			$(function() {
				var page = 0;
				var size = 15;
				var map, geolocation;
			    //加载地图，调用浏览器定位服务
			    map = new AMap.Map('', {
			        resizeEnable: true
			    });
			    map.plugin('AMap.Geolocation', function() {
			        geolocation = new AMap.Geolocation({
			            enableHighAccuracy: true,//是否使用高精度定位，默认:true
			            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
			            buttonPosition:'RB'
			        });
			        geolocation.getCurrentPosition();
			        AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
			        AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
			    });
			    //解析定位结果
			    function onComplete(data) {
			    	districtName = data.addressComponent.district;
           			getSign(districtName);//获取区域标签
			    }
			    //解析定位错误信息
			    function onError(data) {
			    	mui.toast("获取当前位置失败！");
			    }
			    
			    function getSign(districtName){
			    	mui.rAjax({
						url:'/ajax.php',
						data:{
							act: "sign",
							name: districtName
						},
						dataType:'json',//服务器返回json格式数据
						type:'GET',//HTTP请求类型
						timeout:10000,//超时时间设置为10秒；
						success:function(data){
							var dropload = $('.inner').dropload({
								scrollArea : window,
								domDown: {
									domClass: 'dropload-down',
									domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
									domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
									domNoData: '<div class="dropload-noData">没有更多数据了</div>'
								},
								loadDownFn: function(me) {
									page++;
									$.ajax({
										url: mui.apiUrl + '/ajax.php?act=news',
										data: {
											sign: data.datas.sign,
											page: page,
											len: size
										},
										dataType: 'json', //服务器返回json格式数据
										type: 'POST', //HTTP请求类型
										crossDomain:true,
										xhrFields:{
											withCredentials:true
										},
										timeout: 10000, //超时时间设置为10秒；
										success: function(data) {
											if(data.responseCode == 0){
												var result = '';
												if(!!data.datas) {
													for(var i = 0; i < data.datas.length; i++) {
														result += '<a class="item opacity" href="javascript:goDetail(' + data.datas[i].id + ')">' +
															'<h3>' + data.datas[i].title + '</h3>' +
															'<span class="date">' + data.datas[i].time.substr(0,10) + '</span>' +
															'</a>';
													}
													if(data.datas.length < size) {
														// 锁定
														me.lock();
														// 无数据
														me.noData();
													}
												} else {
													// 锁定
													me.lock();
													// 无数据
													me.noData();
												}
												// 为了测试，延迟1秒加载
												setTimeout(function() {
													$('.lists').append(result);
													// 每次数据加载完，必须重置
													me.resetload();
												}, 500);
											}else if(data.responseCode == 1){
												mui.toast(data.responseMsg)
											}
											
										},
										error: function(xhr, type) {
											mui.toast('Ajax error!');
											// 即使加载出错，也得重置
											me.resetload();
										}
									});
								}
							});
						},
						error:function(xhr,type,errorThrown){
							//异常处理；
							console.log(type);
						}
					});
			    }
			    
			});
			
			function goDetail(id){
				window.location.href = "volunterDetail.html?rid=" + id;
			}
		</script>
	</body>

</html>
